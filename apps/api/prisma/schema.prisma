// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ============================================================
// USERS & AUTHENTICATION
// ============================================================

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  googleId  String?  @unique
  tier      String   @default("FREE") // FREE | PRO | CREATOR
  secretKey String?  // Encrypted per-user key for pseudonymization

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime? // Soft delete for GDPR compliance

  // Relations
  graphs        Graph[]
  uploads       Upload[]
  exports       Export[]
  subscription  Subscription?
  refreshTokens RefreshToken[]

  @@index([email])
  @@index([googleId])
  @@index([tier])
}

model RefreshToken {
  id        String    @id @default(cuid())
  token     String    @unique
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  expiresAt DateTime
  createdAt DateTime  @default(now())
  revokedAt DateTime?

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
}

model MagicLink {
  id        String    @id @default(cuid())
  token     String    @unique
  email     String

  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  @@index([token])
  @@index([email])
  @@index([expiresAt])
}

// ============================================================
// GRAPHS & NETWORK DATA
// ============================================================

model Graph {
  id        String @id @default(cuid())
  userId    String
  user      User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  platform  String  // TWITTER | INSTAGRAM | LINKEDIN | FACEBOOK | TIKTOK
  version   Int     @default(1)
  isLatest  Boolean @default(true)
  status    String  @default("PROCESSING") // PROCESSING | READY | ERROR

  // Graph structure stored as JSON for flexibility
  // Array of GraphNode objects
  nodesData String // JSON stored as text for SQLite
  // Array of GraphEdge objects
  edgesData String // JSON stored as text for SQLite
  // GraphMetadata object (parsing info, source file, errors)
  metadata  String // JSON stored as text for SQLite

  // Computed statistics (cached, nullable until processing completes)
  // GraphStatistics object
  statistics String? // JSON stored as text for SQLite

  // Processing error message if status is ERROR
  errorMsg   String?

  // Relations
  insights   Insight[]
  exports    Export[]

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([userId, platform, version])
  @@index([userId])
  @@index([platform])
  @@index([isLatest])
  @@index([status])
  @@index([createdAt])
}

// ============================================================
// UPLOADS
// ============================================================

model Upload {
  id        String @id @default(cuid())
  userId    String
  user      User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  platform  String // TWITTER | INSTAGRAM | LINKEDIN | FACEBOOK | TIKTOK
  fileName  String
  fileSize  Int    // bytes
  checksum  String? // SHA-256 hash

  // Tus upload URL (for resumable uploads)
  uploadUrl String?

  status    String @default("PENDING") // PENDING | UPLOADING | COMPLETED | FAILED | EXPIRED
  errorMsg  String?

  // Upload expires if not completed
  expiresAt   DateTime
  createdAt   DateTime  @default(now())
  completedAt DateTime?

  @@index([userId])
  @@index([status])
  @@index([expiresAt])
}

// ============================================================
// INSIGHTS
// ============================================================

model Insight {
  id        String @id @default(cuid())
  graphId   String
  graph     Graph  @relation(fields: [graphId], references: [id], onDelete: Cascade)

  category  String // NETWORK | COMMUNITY | ENGAGEMENT | GROWTH
  type      String // Specific insight type identifier

  title       String
  description String

  // Insight-specific computed data as JSON
  data        String // JSON stored as text for SQLite
  confidence  String @default("MEDIUM") // HIGH | MEDIUM | LOW

  // Actions as JSON array
  actions     String? // JSON stored as text for SQLite

  // Visual annotations for graph highlighting
  visualAnnotations String? // JSON stored as text for SQLite

  // Display priority (higher = more important)
  priority      Int     @default(0)
  isHighlighted Boolean @default(false)

  // Template tracking for A/B testing
  templateId    String?
  templateVersion String?

  createdAt DateTime @default(now())

  @@index([graphId])
  @@index([category])
  @@index([type])
  @@index([priority])
}

// ============================================================
// EXPORTS
// ============================================================

model Export {
  id        String @id @default(cuid())
  userId    String
  user      User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  graphId   String
  graph     Graph  @relation(fields: [graphId], references: [id], onDelete: Cascade)

  type      String // PDF_REPORT | SOCIAL_CARD | DATA_CSV | DATA_JSON
  format    String // PDF | PNG | JPG | CSV | JSON
  status    String @default("PENDING") // PENDING | PROCESSING | COMPLETED | FAILED

  // File info (populated when completed)
  fileUrl   String?
  fileSize  Int?    // bytes
  fileName  String?

  // Export options as JSON
  options   String? // JSON stored as text for SQLite

  // Error message if failed
  errorMsg  String?

  // Download link expiration
  expiresAt   DateTime?
  createdAt   DateTime   @default(now())
  completedAt DateTime?

  @@index([userId])
  @@index([graphId])
  @@index([status])
  @@index([createdAt])
}

// ============================================================
// SUBSCRIPTIONS & BILLING
// ============================================================

model Subscription {
  id                   String  @id @default(cuid())
  userId               String  @unique
  user                 User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  stripeCustomerId     String  @unique
  stripeSubscriptionId String? @unique
  stripePriceId        String?

  status               String  @default("INACTIVE") // ACTIVE | INACTIVE | PAST_DUE | CANCELED | TRIALING

  currentPeriodStart   DateTime?
  currentPeriodEnd     DateTime?
  cancelAtPeriodEnd    Boolean   @default(false)

  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  canceledAt           DateTime?

  @@index([stripeCustomerId])
  @@index([stripeSubscriptionId])
  @@index([status])
}

// ============================================================
// ANALYTICS & TRACKING (Optional - for usage metrics)
// ============================================================

model AnalyticsEvent {
  id        String   @id @default(cuid())
  userId    String?  // Nullable for anonymous events

  event     String   // Event name (e.g., "graph_created", "export_downloaded")
  properties String? // JSON stored as text for SQLite

  sessionId String?
  ipHash    String?  // Hashed IP for privacy
  userAgent String?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([event])
  @@index([createdAt])
}
